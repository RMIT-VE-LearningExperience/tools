<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCORM Converter</title>
  <!-- JSZip for ZIP generation -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <!-- FileSaver for saving ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 2rem; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 1rem; }
    input[type=file] { display: block; margin: 1rem 0; }
    button { padding: 0.75rem 1.5rem; font-size: 1rem; border: none; background: #007ACC; color: #fff; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .note { font-size: 0.9rem; color: #555; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SCORM 1.2 Converter</h1>
    <p>Select your HTML activity file below to generate a SCORM 1.2 package:</p>
    <input type="file" id="htmlFile" accept=".html">
    <button id="convertBtn" disabled>Convert to SCORM</button>
    <p class="note">The output will be a ZIP you can upload directly to Canvas LMS.</p>
  </div>

  <script>
    const convertBtn = document.getElementById('convertBtn');
    const fileInput = document.getElementById('htmlFile');

    // SCORM 1.2 manifest template
    const manifestTemplate = `<?xml version="1.0" encoding="UTF-8"?>
<manifest identifier="com.generated.scorm" version="1.0"
    xmlns="http://www.imsglobal.org/xsd/imscp_v1p1"
    xmlns:adlcp="http://www.adlnet.org/xsd/adlcp_v1p3"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.imsglobal.org/xsd/imscp_v1p1
    http://www.imsglobal.org/xsd/imscp_v1p1.xsd
    http://www.adlnet.org/xsd/adlcp_v1p3
    http://www.adlnet.org/xsd/adlcp_v1p3.xsd">
  <metadata>
    <schema>ADL SCORM</schema>
    <schemaversion>1.2</schemaversion>
  </metadata>
  <organizations default="ORG1">
    <organization identifier="ORG1">
      <title>HTML Activity</title>
      <item identifier="ITEM1" identifierref="RES1">
        <title>HTML Activity SCO</title>
      </item>
    </organization>
  </organizations>
  <resources>
    <resource identifier="RES1" type="webcontent" adlcp:scormType="sco" href="index.html">
      <file href="index.html"/>
    </resource>
  </resources>
</manifest>`;

    // SCORM injection script
    const scormScript = `
<script>
  var scorm = {
    initialized: false,
    init: function() {
      try {
        this.api = window.API || window.parent.API || window.top.API;
        if (this.api && this.api.LMSInitialize("")) {
          this.initialized = true;
          this.api.LMSSetValue("cmi.core.lesson_status", "incomplete");
          this.api.LMSCommit("");
        }
      } catch(e) { console.error(e); }
    },
    complete: function() {
      try {
        if (this.initialized) {
          this.api.LMSSetValue("cmi.core.lesson_status", "completed");
          this.api.LMSCommit("");
          this.api.LMSFinish("");
        }
      } catch(e) { console.error(e); }
    }
  };
  window.addEventListener('load', ()=> scorm.init());
  function completeSCORMActivity(){ scorm.complete(); }
</script>
`;

    // Hook where to fire completion
    const completionHook = `document.getElementById('completion').classList.remove('hidden');`;

    fileInput.addEventListener('change', () => {
      convertBtn.disabled = !fileInput.files.length;
    });

    convertBtn.addEventListener('click', () => {
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        let html = reader.result;

        // Inject completion call if hook exists
        if (html.includes(completionHook)) {
          html = html.replace(
            completionHook,
            completionHook + "\n      completeSCORMActivity();"
          );
        }

        // Inject SCORM script before </body>
        html = html.replace('</body>', scormScript + '\n</body>');

        // Create ZIP
        const zip = new JSZip();
        zip.file('index.html', html);
        zip.file('imsmanifest.xml', manifestTemplate);
        zip.generateAsync({ type: 'blob' }).then(blob => {
          saveAs(blob, 'scorm_package.zip');
        });
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>